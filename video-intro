#!/usr/bin/env python3
"""
video-intro: Add a title screen image to the beginning of a video.
"""

import argparse
import json
import subprocess
import sys
import os
from pathlib import Path


def get_video_info(video_path: str) -> dict:
    """Get video properties using ffprobe."""
    cmd = [
        "ffprobe",
        "-v", "error",
        "-select_streams", "v:0",
        "-show_entries", "stream=width,height,r_frame_rate,pix_fmt",
        "-of", "json",
        video_path
    ]
    result = subprocess.run(cmd, capture_output=True, text=True, check=True)
    data = json.loads(result.stdout)
    stream = data["streams"][0]

    # Parse frame rate (e.g., "30/1" or "30000/1001")
    fps_parts = stream["r_frame_rate"].split("/")
    fps = float(fps_parts[0]) / float(fps_parts[1])
    fps_str = stream["r_frame_rate"]

    return {
        "width": int(stream["width"]),
        "height": int(stream["height"]),
        "fps": fps,
        "fps_str": fps_str,
        "pix_fmt": stream.get("pix_fmt", "yuv420p")
    }


def has_audio(video_path: str) -> bool:
    """Check if video has an audio stream."""
    cmd = [
        "ffprobe",
        "-v", "error",
        "-select_streams", "a:0",
        "-show_entries", "stream=codec_name",
        "-of", "json",
        video_path
    ]
    result = subprocess.run(cmd, capture_output=True, text=True, check=True)
    data = json.loads(result.stdout)
    return bool(data.get("streams"))


def create_video_with_intro(
    image_path: str,
    video_path: str,
    duration: float,
    output_path: str
) -> None:
    """Create output video with intro image prepended using filter_complex."""
    video_info = get_video_info(video_path)
    has_audio_track = has_audio(video_path)

    w, h = video_info["width"], video_info["height"]
    fps = video_info["fps_str"]
    pix_fmt = video_info["pix_fmt"]

    # Build filter_complex
    # [0:v] = image input (looped)
    # [1:v] = video input
    # [1:a] = audio input (if exists)
    # [2:a] = silent audio (if video has audio)

    video_filter = (
        f"[0:v]loop=loop=-1:size=1:start=0,"
        f"scale={w}:{h}:force_original_aspect_ratio=decrease,"
        f"pad={w}:{h}:(ow-iw)/2:(oh-ih)/2,"
        f"setsar=1,fps={fps},format={pix_fmt},"
        f"trim=duration={duration},setpts=PTS-STARTPTS[intro];"
        f"[1:v]setpts=PTS-STARTPTS[main];"
        f"[intro][main]concat=n=2:v=1:a=0[outv]"
    )

    if has_audio_track:
        audio_filter = (
            f";[2:a]atrim=duration={duration},asetpts=PTS-STARTPTS[introa];"
            f"[1:a]asetpts=PTS-STARTPTS[maina];"
            f"[introa][maina]concat=n=2:v=0:a=1[outa]"
        )
        filter_complex = video_filter + audio_filter
        maps = ["-map", "[outv]", "-map", "[outa]"]
    else:
        filter_complex = video_filter
        maps = ["-map", "[outv]"]

    args = [
        "ffmpeg", "-y",
        "-loop", "1",
        "-i", image_path,
        "-i", video_path,
    ]

    if has_audio_track:
        args.extend(["-f", "lavfi", "-i", "anullsrc=channel_layout=stereo:sample_rate=48000"])

    args.extend([
        "-filter_complex", filter_complex,
        *maps,
        "-c:v", "libx264",
        "-preset", "fast",
        "-crf", "18",
    ])

    if has_audio_track:
        args.extend(["-c:a", "aac", "-b:a", "192k"])

    args.append(output_path)

    result = subprocess.run(args, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"Error: {result.stderr}", file=sys.stderr)
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(
        description="Add a title screen image to the beginning of a video.",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  video-intro --image title.png --video screencast.mp4 --output final.mp4
  video-intro -i logo.png -v demo.mp4 -d 3 -o output.mp4
        """
    )

    parser.add_argument(
        "-i", "--image",
        required=True,
        help="Path to the title screen image (PNG, JPG, etc.)"
    )
    parser.add_argument(
        "-v", "--video",
        required=True,
        help="Path to the input video (MP4)"
    )
    parser.add_argument(
        "-d", "--duration",
        type=float,
        required=True,
        help="Duration of the title screen in seconds"
    )
    parser.add_argument(
        "-o", "--output",
        required=True,
        help="Path for the output video"
    )

    args = parser.parse_args()

    # Validate inputs
    image_path = os.path.abspath(os.path.expanduser(args.image))
    video_path = os.path.abspath(os.path.expanduser(args.video))

    if not Path(image_path).exists():
        print(f"Error: Image file not found: {image_path}", file=sys.stderr)
        sys.exit(1)

    if not Path(video_path).exists():
        print(f"Error: Video file not found: {video_path}", file=sys.stderr)
        sys.exit(1)

    if args.duration <= 0:
        print("Error: Duration must be positive", file=sys.stderr)
        sys.exit(1)

    # Check for FFmpeg
    try:
        subprocess.run(["ffmpeg", "-version"], capture_output=True, check=True)
    except FileNotFoundError:
        print("Error: FFmpeg not found. Please install FFmpeg.", file=sys.stderr)
        sys.exit(1)

    print(f"Adding {args.duration}s intro to: {video_path}")
    create_video_with_intro(image_path, video_path, args.duration, args.output)
    print(f"Output saved to: {args.output}")


if __name__ == "__main__":
    main()
